<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Taurus AI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * { box-sizing: border-box; }
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    .loading { border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; display:inline-block; vertical-align:middle; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .left-col { min-width: 320px; max-width: 380px; }
    main { min-width: 0; } /* allow flex shrink */
    .model-option { transition: background-color .12s; }
    .model-option:hover { background-color: rgba(0,0,0,0.04); }
    .results-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 12px; }
    .image-card { transition: transform .12s, box-shadow .12s; position:relative; overflow:hidden; }
    .image-card:hover { transform: translateY(-3px); box-shadow: 0 6px 18px rgba(0,0,0,0.06); }
    .image-thumb { width:100%; height:120px; object-fit:cover; border-radius:8px; display:block; }
    .nsfw-overlay { position:absolute; inset:0; background:linear-gradient(180deg, rgba(0,0,0,0.35), rgba(0,0,0,0.6)); display:flex; align-items:center; justify-content:center; color:white; font-weight:600; gap:8px; cursor:pointer; }
    .silhouette { width: 28px; height: 28px; display:inline-block; vertical-align:middle; }
    .image-preview-small { width:80px; height:56px; object-fit:cover; border-radius:6px; border:1px solid #e5e7eb; }
    .muted { color:#6b7280; }
    /* right sidebar */
    aside.right { width: 320px; border-left: 1px solid #e5e7eb; background: #fff; padding: 16px; position: fixed; right: 0; top: 0; bottom: 0; overflow:auto; }
    .preset-btn { padding:6px 8px; border-radius:6px; background:#f3f4f6; font-size:13px; cursor:pointer; }
    .preset-btn:hover { background:#e5e7eb; }
    .tag { display:inline-block; padding:4px 8px; background:#f8fafc; border-radius:999px; margin:3px; font-size:12px; cursor:pointer; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <div class="min-h-screen flex">
    <!-- Left: existing left sidebar (KEEP as-is) -->
    <aside class="left-col bg-white border-r border-gray-200 p-4 flex flex-col gap-4">
      <!-- Logo + title -->
      <div class="flex items-center gap-3">
        <svg class="silhouette" viewBox="0 0 24 24" fill="none"><path d="M12 2c2 2 6 3 8 5s3 6 1 8-6 3-8 5-6-3-8-5-1-6 1-8 6-3 8-5z" fill="#111827"/></svg>
        <div>
          <div class="text-lg font-semibold">Taurus AI</div>
          <div class="text-xs muted">Image generation Â· compact UI</div>
        </div>
      </div>

      <!-- Model selector (unchanged behavior, dynamic fill) -->
      <div class="border-t border-gray-100 pt-3">
        <label class="text-xs text-gray-600">Model</label>
        <div class="relative mt-2">
          <button id="modelDropdownButton" aria-haspopup="listbox" aria-expanded="false" class="w-full text-left px-3 py-2 bg-gray-100 rounded-lg flex items-center justify-between" onclick="toggleModelDropdown()">
            <div class="flex items-center gap-2">
              <span id="selectedModelIcon" class="silhouette" aria-hidden="true"></span>
              <span id="selectedModelName" class="font-medium text-sm">Flux</span>
            </div>
            <svg class="w-4 h-4 text-gray-600" viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5z"/></svg>
          </button>
          <div id="modelDropdown" class="model-dropdown mt-2 absolute left-0 right-0 bg-white border border-gray-200 rounded-lg shadow-sm z-30 hidden" role="listbox">
            <div class="p-2" id="modelDropdownInner"></div>
          </div>
          <div id="modelAuthWarning" class="mt-2 text-xs text-red-600 hidden"></div>
        </div>
      </div>

      <!-- Prompt -->
      <div class="border-t border-gray-100 pt-3">
        <label class="text-xs text-gray-600">Prompt</label>
        <textarea id="promptInput" rows="3" class="w-full mt-2 px-3 py-2 rounded-lg border border-gray-200 bg-gray-50" placeholder="Describe the image you want (keeps content while generating)"></textarea>
      </div>

      <!-- Aspect & Size -->
      <div class="border-t border-gray-100 pt-3">
        <div class="flex items-center justify-between">
          <label class="text-xs text-gray-600">Aspect & Size</label>
          <div class="small-txt" id="detectedAspectLabel">Auto</div>
        </div>
        <div class="mt-2 flex gap-2">
          <button class="preset-btn" onclick="setPresetAspect(1,1)">1:1</button>
          <button class="preset-btn" onclick="setPresetAspect(16,9)">16:9</button>
          <button class="preset-btn" onclick="setPresetAspect(9,16)">9:16</button>
          <button class="preset-btn" onclick="setPresetAspect(3,2)">3:2</button>
        </div>
        <div class="mt-2 grid grid-cols-2 gap-2">
          <input id="widthInput" type="number" value="1024" min="128" max="4096" step="1" class="px-2 py-2 rounded-lg border border-gray-200 text-sm" placeholder="Width">
          <input id="heightInput" type="number" value="1024" min="128" max="4096" step="1" class="px-2 py-2 rounded-lg border border-gray-200 text-sm" placeholder="Height">
        </div>
        <div class="mt-2">
          <button id="useImgAspectBtn" class="preset-btn hidden">Use ref aspect</button>
        </div>
      </div>

      <!-- Image reference (only visible when kontext selected) -->
      <div class="border-t border-gray-100 pt-3" id="imageRefSection" style="display:none;">
        <label class="text-xs text-gray-600">Image reference (paste URL)</label>
        <div class="mt-2 flex gap-2 items-center">
          <input id="imageRefUrl" type="url" placeholder="Paste image URL (img2img)" class="flex-1 px-3 py-2 rounded-lg border border-gray-200 text-sm" />
          <button id="addImageRefBtn" class="px-2 py-2 bg-blue-600 text-white rounded-lg hidden">Add</button>
        </div>
        <div id="imageRefPreviewWrap" class="mt-2 hidden">
          <div class="flex items-center gap-2">
            <img id="imageRefPreview" src="" alt="preview" class="image-preview-small" />
            <div class="text-xs muted">
              <div id="imageRefInfo">Reference preview</div>
              <div id="imageRefSize"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Seed + watermark/nologo (kept) -->
      <div class="border-t border-gray-100 pt-3">
        <label class="text-xs text-gray-600">Seed & Controls</label>
        <div class="mt-2 grid grid-cols-2 gap-2">
          <input id="seedInput" type="number" placeholder="Optional seed" class="px-2 py-2 rounded-lg border border-gray-200 text-sm" />
          <button id="randomSeedBtn" class="px-2 py-2 bg-gray-100 rounded">ðŸŽ²</button>
        </div>
        <div class="mt-2 flex items-center gap-2 small-txt">
          <label class="flex items-center gap-2"><input id="lockSeed" type="checkbox" /> Lock seed</label>
          <label class="flex items-center gap-2 ml-auto"><input id="nologoCheck" type="checkbox" checked /> Remove watermark</label>
        </div>

        <div class="mt-2 flex items-center gap-2">
          <label class="flex items-center gap-2"><input id="nsfwToggle" type="checkbox" /> Allow NSFW</label>
          <div class="muted ml-auto">If enabled, thumbnails will be hidden until revealed</div>
        </div>
      </div>

      <div class="mt-4">
        <div class="flex gap-2">
          <button id="generateBtn" class="flex-1 px-3 py-2 bg-blue-600 text-white rounded-lg">Generate</button>
          <button id="clearAllBtn" class="px-3 py-2 bg-gray-100 rounded-lg">Clear</button>
        </div>
      </div>

    </aside>

    <!-- Main content -->
    <main class="flex-1 p-6 flex flex-col gap-6" style="margin-right:340px;">
      <header class="flex items-center justify-between">
        <div>
          <h2 class="text-lg font-semibold">Generated images</h2>
          <p class="text-sm text-gray-500">Compact grid â€” click a thumbnail to preview details.</p>
        </div>
        <div class="text-sm text-gray-600" id="statusSummary">Idle</div>
      </header>

      <section id="resultsWrapper" class="flex-1 overflow-hidden">
        <div id="resultsArea" class="results-grid scrollable p-2 h-full" style="height: calc(100% - 8px);"></div>
      </section>
    </main>

    <!-- Right sidebar: options (always visible) -->
    <aside class="right" id="rightSidebar">
      <h3 class="text-sm font-semibold mb-2">Advanced Options</h3>

      <div class="mb-3">
        <label class="text-xs text-gray-600">Negative Prompt Presets</label>
        <div class="mt-2 grid gap-2">
          <!-- examples; you can expand these lists -->
          <div>
            <span class="tag" data-val="lowres, bad anatomy, text" onclick="applyNegativePreset(this)">Common junk</span>
            <span class="tag" data-val="deformed, extra limbs, watermark" onclick="applyNegativePreset(this)">Artifacts</span>
            <span class="tag" data-val="blurry, low quality, out of focus" onclick="applyNegativePreset(this)">Quality</span>
            <span class="tag" data-val="photorealistic, face detected" onclick="applyNegativePreset(this)">Faces (avoid)</span>
          </div>
        </div>
        <div class="mt-2">
          <button class="preset-btn" onclick="clearNegativePrompt()">Clear negative</button>
        </div>
      </div>

      <div class="mb-3">
        <label class="text-xs text-gray-600">Art Style (click to append)</label>
        <div class="mt-2">
          <div id="styleTags" style="display:flex;flex-wrap:wrap;gap:6px">
            <span class="tag" data-val="photorealistic" onclick="appendTrait(this)">Photorealistic</span>
            <span class="tag" data-val="oil painting" onclick="appendTrait(this)">Oil painting</span>
            <span class="tag" data-val="watercolor" onclick="appendTrait(this)">Watercolor</span>
            <span class="tag" data-val="anime" onclick="appendTrait(this)">Anime</span>
            <span class="tag" data-val="cyberpunk" onclick="appendTrait(this)">Cyberpunk</span>
            <span class="tag" data-val="studio lighting" onclick="appendTrait(this)">Studio lighting</span>
          </div>
        </div>
      </div>

      <div class="mb-3">
        <label class="text-xs text-gray-600">Pose</label>
        <div class="mt-2" id="poseTags">
          <span class="tag" data-val="standing" onclick="appendTrait(this)">Standing</span>
          <span class="tag" data-val="sitting" onclick="appendTrait(this)">Sitting</span>
          <span class="tag" data-val="running" onclick="appendTrait(this)">Running</span>
          <span class="tag" data-val="close-up portrait" onclick="appendTrait(this)">Close-up</span>
        </div>
      </div>

      <div class="mb-3">
        <label class="text-xs text-gray-600">Shot / View</label>
        <div class="mt-2">
          <span class="tag" data-val="wide shot" onclick="appendTrait(this)">Wide</span>
          <span class="tag" data-val="medium shot" onclick="appendTrait(this)">Medium</span>
          <span class="tag" data-val="close up" onclick="appendTrait(this)">Close up</span>
          <span class="tag" data-val="birds-eye view" onclick="appendTrait(this)">Bird's-eye</span>
        </div>
      </div>

      <div class="mb-3">
        <label class="text-xs text-gray-600">CFG / Scale / Steps / Sampler</label>
        <div class="mt-2 grid grid-cols-2 gap-2">
          <input id="cfgScale" type="number" step="0.1" value="7.0" class="px-2 py-2 rounded border border-gray-200 text-sm" placeholder="CFG / Scale">
          <input id="steps" type="number" step="1" value="28" class="px-2 py-2 rounded border border-gray-200 text-sm" placeholder="Steps">
        </div>
        <div class="mt-2">
          <select id="sampler" class="w-full px-2 py-2 rounded border border-gray-200 text-sm">
            <option value="k_lms">k_lms</option>
            <option value="ddim">ddim</option>
            <option value="plms">plms</option>
            <option value="k_euler">k_euler</option>
            <option value="k_euler_ancestral">k_euler_ancestral</option>
          </select>
        </div>
      </div>

      <div class="text-xs text-gray-500">
        These options append to the prompt / request automatically. Negative presets apply instantly to the negative prompt parameter.
      </div>
    </aside>
  </div>

  <!-- Preview Modal -->
  <div id="previewModal" class="fixed inset-0 hidden items-center justify-center z-50">
    <div class="modal-backdrop absolute inset-0"></div>
    <div class="relative z-10 max-w-4xl w-full mx-4 bg-white rounded-lg overflow-hidden shadow-xl">
      <div class="flex items-center justify-between p-3 border-b border-gray-100">
        <div class="flex items-center gap-3">
          <div id="previewStatusPill" class="status-pill status-done">Status</div>
          <div id="previewModel" class="text-sm text-gray-600">Model</div>
        </div>
        <div class="flex items-center gap-2">
          <button id="previewDownloadBtn" class="px-3 py-1.5 bg-gray-100 rounded">Download</button>
          <button onclick="closePreview()" class="px-3 py-1.5 bg-red-50 text-red-600 rounded">Close</button>
        </div>
      </div>
      <div class="p-4 grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="flex items-center justify-center bg-gray-50 p-4">
          <img id="previewImage" src="" alt="Preview" class="max-h-[60vh] object-contain w-full" />
        </div>
        <div>
          <h3 class="font-medium text-sm mb-2">Prompt</h3>
          <pre id="previewPrompt" class="bg-gray-50 rounded p-2 text-sm text-gray-700 whitespace-pre-wrap"></pre>
          <div class="mt-4 text-sm text-gray-600">
            <div><strong>Model:</strong> <span id="previewModelDetail"></span></div>
            <div class="mt-2"><strong>Seed:</strong> <span id="previewSeedDetail"></span></div>
            <div class="mt-2"><strong>Size:</strong> <span id="previewSizeDetail"></span></div>
            <div class="mt-2"><strong>Generated at:</strong> <span id="previewTimeDetail"></span></div>
            <div class="mt-3"><strong>Status detail:</strong><div id="previewDetailText" class="mt-1 text-xs text-gray-500"></div></div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/* Helpers */
function el(tag, props = {}, ...children) {
  const node = document.createElement(tag);
  Object.entries(props).forEach(([k,v]) => {
    if (k === 'class') node.className = v;
    else if (k.startsWith('data-')) node.setAttribute(k, v);
    else node[k] = v;
  });
  children.forEach(ch => { if (typeof ch === 'string') node.appendChild(document.createTextNode(ch)); else if (ch) node.appendChild(ch); });
  return node;
}
function fmtTime(ts = Date.now()){ return new Date(ts).toLocaleString(); }

/* Model icons (silhouette mapping) */
function modelIconSvg(id) {
  const svgs = {
    flux: '<svg class="silhouette" viewBox="0 0 24 24" fill="none"><path d="M12 2C9 6 6 8 4 9c2 2 6 4 8 6s6 2 8 0c0-4-4-9-8-13z" fill="#111"/></svg>',
    turbo: '<svg class="silhouette" viewBox="0 0 24 24" fill="none"><path d="M2 12c3-4 8-6 10-6s7 2 10 6c-3 4-8 6-10 6S5 16 2 12z" fill="#111"/></svg>',
    'flux-realism': '<svg class="silhouette" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="14" rx="2" fill="#111"/></svg>',
    kontext: '<svg class="silhouette" viewBox="0 0 24 24"><path d="M3 7h18v10H3z" fill="#111"/></svg>',
    realism: '<svg class="silhouette" viewBox="0 0 24 24"><circle cx="12" cy="10" r="5" fill="#111"/></svg>',
    stable: '<svg class="silhouette" viewBox="0 0 24 24"><path d="M4 4h16v16H4z" fill="#111"/></svg>',
    default: '<svg class="silhouette" viewBox="0 0 24 24"><path d="M12 2l3 6 6 3-6 3-3 6-3-6-6-3 6-3z" fill="#111"/></svg>'
  };
  return svgs[id] || svgs.default;
}

/* Populate models */
async function populateModelDropdown() {
  const inner = document.getElementById('modelDropdownInner');
  inner.innerHTML = '<div class="text-xs muted">Loading models...</div>';
  try {
    const resp = await fetch('/api/models');
    const data = await resp.json();
    const models = (data && data.models) ? data.models : [];
    inner.innerHTML = '';
    models.forEach((m,i) => {
      const div = document.createElement('div');
      div.className = 'model-option flex items-center gap-3 px-3 py-2 rounded cursor-pointer';
      div.setAttribute('data-model', m.id);
      div.setAttribute('data-requires-auth', m.requiresAuth ? 'true' : 'false');
      div.setAttribute('data-desc', m.desc || '');
      div.innerHTML = `${modelIconSvg(m.id)}<div><div class="text-sm font-medium">${m.name || m.id}</div><div class="text-xs muted">${m.desc || ''}</div></div>`;
      div.addEventListener('click', () => selectModelFromElement(div));
      inner.appendChild(div);
      if (i===0) selectModelFromElement(div);
    });
    if (models.length === 0) inner.innerHTML = '<div class="text-xs muted">No models found</div>';
  } catch (err) {
    console.warn('populateModelDropdown failed', err);
    inner.innerHTML = '<div class="text-xs muted">Failed to load â€” using fallback</div>';
  }
}

function toggleModelDropdown(){
  const dd = document.getElementById('modelDropdown');
  dd.classList.toggle('hidden');
  document.getElementById('modelDropdownButton').setAttribute('aria-expanded', (!dd.classList.contains('hidden')).toString());
}

function selectModelFromElement(el) {
  const model = el.getAttribute('data-model');
  const requiresAuth = el.getAttribute('data-requires-auth') === 'true';
  document.getElementById('selectedModelName').textContent = el.querySelector('.text-sm')?.textContent || model;
  document.getElementById('selectedModelIcon').innerHTML = el.querySelector('.silhouette')?.outerHTML || modelIconSvg(model);
  document.getElementById('modelDropdown').dataset.selectedModel = model;
  const imageRefSection = document.getElementById('imageRefSection');
  if (model === 'kontext') { imageRefSection.style.display = 'block'; document.getElementById('useImgAspectBtn').classList.remove('hidden'); }
  else { imageRefSection.style.display = 'none'; document.getElementById('useImgAspectBtn').classList.add('hidden'); }
  const warn = document.getElementById('modelAuthWarning');
  if (requiresAuth) { warn.innerHTML = `Model requires server API key (POLLINATIONS_API_KEY) or test key.`; warn.classList.remove('hidden'); } else { warn.classList.add('hidden'); warn.innerHTML = ''; }
  document.getElementById('modelDropdown').classList.add('hidden');
  document.getElementById('modelDropdownButton').setAttribute('aria-expanded','false');
}

/* Aspect ratio and presets */
function setPresetAspect(a,b) {
  const scaleW = 1024;
  const newW = Math.max(128, Math.round(scaleW));
  const newH = Math.max(128, Math.round(newW * (b / a)));
  document.getElementById('widthInput').value = newW;
  document.getElementById('heightInput').value = newH;
  document.getElementById('detectedAspectLabel').textContent = `${a}:${b}`;
}
document.getElementById?.('useImgAspectBtn')?.addEventListener?.('click', () => {
  if (window._lastRefAspect) {
    const [w,h] = window._lastRefAspect;
    document.getElementById('widthInput').value = Math.max(128, Math.round(w));
    document.getElementById('heightInput').value = Math.max(128, Math.round(h));
    document.getElementById('detectedAspectLabel').textContent = `Ref ${Math.round(w)}Ã—${Math.round(h)}`;
  }
});

/* Image reference preview & paste/add */
const imgRefInput = document.getElementById('imageRefUrl');
const addImgBtn = document.getElementById('addImageRefBtn');
const imgRefPreviewWrap = document.getElementById('imageRefPreviewWrap');
const imgRefPreview = document.getElementById('imageRefPreview');
const imgRefInfo = document.getElementById('imageRefInfo');
const imgRefSize = document.getElementById('imageRefSize');

function isLikelyImageUrl(url) {
  if (!url) return false;
  try { new URL(url); } catch(e) { return false; }
  return /\.(jpe?g|png|gif|webp|bmp|avif|svg)$/i.test(url.split('?')[0]);
}

imgRefInput?.addEventListener('input', (e) => {
  const v = (e.target.value || '').trim();
  if (isLikelyImageUrl(v)) addImgBtn.classList.remove('hidden'); else addImgBtn.classList.add('hidden');
});

addImgBtn?.addEventListener('click', async () => {
  const url = (imgRefInput.value || '').trim();
  if (!isLikelyImageUrl(url)) { alert('URL not recognized as an image'); return; }
  try {
    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.onload = () => {
      imgRefPreview.src = url;
      imgRefPreviewWrap.classList.remove('hidden');
      addImgBtn.classList.add('hidden');
      const naturalW = img.naturalWidth || Number(document.getElementById('widthInput').value) || 1024;
      const naturalH = img.naturalHeight || Number(document.getElementById('heightInput').value) || 1024;
      window._lastRefAspect = [naturalW, naturalH];
      imgRefInfo.textContent = `${naturalW}Ã—${naturalH}`;
      imgRefSize.textContent = `${Math.round((naturalW*naturalH)/1000)} kpx`;
      document.getElementById('useImgAspectBtn').classList.remove('hidden');
      // set default width/height to reference aspect proportion (scale to 1024 width)
      const scaleW = 1024;
      document.getElementById('widthInput').value = scaleW;
      document.getElementById('heightInput').value = Math.max(128, Math.round(scaleW * (naturalH/naturalW)));
    };
    img.onerror = () => {
      alert('Failed to load preview image (CORS or unreachable). The URL may be blocked.');
      imgRefPreviewWrap.classList.add('hidden');
      addImgBtn.classList.remove('hidden');
    };
    img.src = url;
  } catch (e) { console.error('preview error', e); alert('Error previewing image'); }
});

/* Negative prompt presets & traits */
function applyNegativePreset(el) {
  const v = el.getAttribute('data-val') || '';
  const existing = (document.getElementById('negativePromptHidden')?.value || '');
  const newVal = existing ? existing + ', ' + v : v;
  if (!document.getElementById('negativePromptHidden')) {
    const hidden = el('input', { type: 'hidden', id: 'negativePromptHidden', value: newVal });
    document.body.appendChild(hidden);
  } else document.getElementById('negativePromptHidden').value = newVal;
  // visual feedback
  alert('Negative preset applied: ' + v);
}
function clearNegativePrompt() { if (document.getElementById('negativePromptHidden')) document.getElementById('negativePromptHidden').value = ''; alert('Negative prompt cleared'); }

function appendTrait(el) {
  const v = el.getAttribute('data-val') || '';
  const promptEl = document.getElementById('promptInput');
  const cur = (promptEl.value || '').trim();
  promptEl.value = cur ? cur + ', ' + v : v;
}

/* Results grid */
const resultsArea = document.getElementById('resultsArea');
const statusSummary = document.getElementById('statusSummary');

function updateStatusSummary() {
  const cards = resultsArea.querySelectorAll('.image-card');
  const total = cards.length;
  const rendering = resultsArea.querySelectorAll('.image-card[data-status="rendering"]').length;
  const done = resultsArea.querySelectorAll('.image-card[data-status="done"]').length;
  const err = resultsArea.querySelectorAll('.image-card[data-status="error"]').length;
  statusSummary.textContent = `Total ${total} Â· Rendering ${rendering} Â· Done ${done} Â· Error ${err}`;
}
function makeStatusPill(status) {
  const span = el('span', { class: 'status-pill ' + (status === 'rendering' ? 'status-rendering' : status === 'done' ? 'status-done' : 'status-error') });
  if (status === 'rendering') span.innerHTML = '<span class="loading"></span><span>Rendering</span>';
  else if (status === 'done') span.textContent = 'Done';
  else span.textContent = 'Error';
  return span;
}

function createResultCard({ id, prompt, model, seed, width, height, nsfwFlag }) {
  const card = el('div', { class: 'image-card bg-white rounded-lg p-2 border border-gray-100', 'data-id': id, 'data-status': 'rendering' });
  const header = el('div', { class: 'flex items-center justify-between gap-2 mb-2' });
  const left = el('div', { class: 'flex items-center gap-2' });
  left.appendChild(el('div', { class: 'w-8 h-8 rounded-full bg-gradient-to-br from-purple-500 to-blue-500 text-white flex items-center justify-center text-sm font-bold' }, 'T'));
  const meta = el('div', {});
  meta.appendChild(el('div', { class: 'text-sm font-medium truncate', title: prompt }, prompt.length > 60 ? prompt.slice(0,60) + 'â€¦' : prompt));
  meta.appendChild(el('div', { class: 'text-xs muted' }, `${model} â€¢ ${width}Ã—${height}`));
  left.appendChild(meta);
  header.appendChild(left);
  header.appendChild(makeStatusPill('rendering'));
  card.appendChild(header);

  const imgWrap = el('div', { class: 'mb-2 relative' });
  const placeholder = el('div', { class: 'bg-gray-50 rounded-md flex items-center justify-center', style: 'height:120px' }, el('div', { class: 'muted' }, 'Renderingâ€¦'));
  imgWrap.appendChild(placeholder);
  card.appendChild(imgWrap);

  const actions = el('div', { class: 'flex items-center gap-2' });
  const previewBtn = el('button', { class: 'px-2 py-1 text-xs bg-white border rounded' }, 'Preview');
  const downloadBtn = el('button', { class: 'px-2 py-1 text-xs bg-white border rounded' }, 'Download');
  const delBtn = el('button', { class: 'px-2 py-1 text-xs bg-red-50 border border-red-200 rounded' }, 'Delete');
  actions.appendChild(previewBtn); actions.appendChild(downloadBtn); actions.appendChild(delBtn);
  card.appendChild(actions);

  previewBtn.addEventListener('click', () => openPreview(card.dataset));
  downloadBtn.addEventListener('click', () => {
    const url = card.getAttribute('data-imageurl');
    if (url) downloadImage(url);
    else alert('Image not ready');
  });
  delBtn.addEventListener('click', () => { if (confirm('Delete this result?')) card.remove(); updateStatusSummary(); });

  function updateReady({ imageUrl, details }) {
    card.setAttribute('data-imageurl', imageUrl);
    card.setAttribute('data-status', 'done');
    const headRight = header.querySelector('.status-pill');
    headRight.replaceWith(makeStatusPill('done'));
    imgWrap.innerHTML = '';
    const img = el('img', { src: imageUrl, alt: prompt, class: 'image-thumb', loading: 'lazy' });
    img.addEventListener('click', () => openPreview({ id, prompt, model, seed, width, height, imageUrl, details, time: Date.now(), status: 'done' }));
    imgWrap.appendChild(img);
    // nsfw handling: if flagged, overlay a hide until reveal control
    if (nsfwFlag) {
      const overlay = el('div', { class: 'nsfw-overlay', title: 'Click to reveal NSFW preview' }, 'ðŸ”ž Sensitive - Click to reveal');
      overlay.addEventListener('click', () => overlay.remove());
      imgWrap.appendChild(overlay);
    }
    card.dataset.prompt = prompt;
    card.dataset.model = model;
    card.dataset.seed = seed || '';
    card.dataset.width = width;
    card.dataset.height = height;
    card.dataset.generatedAt = Date.now();
    updateStatusSummary();
  }

  function updateError(errMsg) {
    card.setAttribute('data-status', 'error');
    const headRight = header.querySelector('.status-pill');
    headRight.replaceWith(makeStatusPill('error'));
    imgWrap.innerHTML = '';
    imgWrap.appendChild(el('div', { class: 'text-xs text-red-600' }, 'Failed'));
    imgWrap.appendChild(el('div', { class: 'text-xs muted mt-1' }, errMsg || 'Unknown error'));
    card.dataset.error = errMsg || '';
    updateStatusSummary();
  }

  return { card, updateReady, updateError };
}

/* Preview modal functions */
function openPreview(data = {}) {
  const modal = document.getElementById('previewModal');
  document.getElementById('previewImage').src = data.imageUrl || data['imageUrl'] || '';
  document.getElementById('previewPrompt').textContent = data.prompt || data['prompt'] || '';
  document.getElementById('previewModelDetail').textContent = data.model || data['model'] || '';
  document.getElementById('previewSeedDetail').textContent = data.seed || data['seed'] || 'â€”';
  document.getElementById('previewSizeDetail').textContent = `${data.width || data['width'] || 'â€”'} Ã— ${data.height || data['height'] || 'â€”'}`;
  document.getElementById('previewTimeDetail').textContent = data.time ? fmtTime(data.time) : (data.generatedAt ? fmtTime(Number(data.generatedAt)) : 'â€”');
  document.getElementById('previewDetailText').textContent = data.details || data.detail || data.error || '';
  const statusPill = document.getElementById('previewStatusPill');
  statusPill.className = 'status-pill ' + ((data.status === 'rendering') ? 'status-rendering' : (data.status === 'error') ? 'status-error' : 'status-done');
  statusPill.textContent = (data.status === 'rendering') ? 'Rendering' : (data.status === 'error') ? 'Error' : 'Done';
  document.getElementById('previewModel').textContent = data.model || data['model'] || '';
  document.getElementById('previewDownloadBtn').onclick = () => { if (data.imageUrl) downloadImage(data.imageUrl); else alert('No image'); };
  modal.classList.remove('hidden'); modal.classList.add('flex');
}
function closePreview() { const modal = document.getElementById('previewModal'); modal.classList.remove('flex'); modal.classList.add('hidden'); }
function downloadImage(url) { if (!url) return; const a = document.createElement('a'); a.href = url; a.download = `taurus-${Date.now()}.png`; document.body.appendChild(a); a.click(); a.remove(); }

/* Generate flow (include negative_prompt, cfg_scale, steps, sampler, nsfw flag) */
function sessionKey() { try { return localStorage.getItem('POLLINATIONS_SESSION_KEY'); } catch(e) { return null; } }

let counter = 0;
async function generateImage() {
  const prompt = (document.getElementById('promptInput').value || '').trim();
  if (!prompt) return alert('Masukkan prompt terlebih dahulu');

  const width = Math.max(128, parseInt(document.getElementById('widthInput').value) || 1024);
  const height = Math.max(128, parseInt(document.getElementById('heightInput').value) || 1024);
  const cfgScale = parseFloat(document.getElementById('cfgScale')?.value || 7.0);
  const steps = parseInt(document.getElementById('steps')?.value || 28);
  const sampler = document.getElementById('sampler')?.value || 'k_lms';
  const nologo = document.getElementById('nologoCheck').checked;
  const nsfw = document.getElementById('nsfwToggle').checked;

  // seed handling
  const seedInput = document.getElementById('seedInput').value;
  const lockSeed = document.getElementById('lockSeed').checked;
  let seed;
  if (seedInput) seed = Number(seedInput);
  else seed = Math.floor(Math.random() * 1000000);
  if (lockSeed) document.getElementById('seedInput').value = seed;

  const model = document.getElementById('modelDropdown').dataset.selectedModel || 'flux';
  const imageRefValue = (document.getElementById('imageRefUrl').value || '').trim() || undefined;
  const clientKey = sessionKey();

  // negative prompt
  const negativePrompt = (document.getElementById('negativePromptHidden')?.value || '').trim() || undefined;

  // create placeholder card
  const id = 'r' + (++counter);
  const { card, updateReady, updateError } = createResultCard({ id, prompt, model, seed, width, height, nsfwFlag: nsfw });
  resultsArea.insertBefore(card, resultsArea.firstChild);
  updateStatusSummary();

  // build payload
  const payload = { prompt, model, width, height, seed, cfg_scale: cfgScale, steps, sampler, nologo };
  if (negativePrompt) payload.negative_prompt = negativePrompt;
  if (imageRefValue && model === 'kontext') payload.imageUrl = imageRefValue;
  if (nsfw) payload.nsfw = true;
  if (clientKey) payload.clientKey = clientKey;

  try {
    const resp = await fetch('/api/generate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const data = await resp.json().catch(()=>({}));
    if (!resp.ok || !data || !data.success) {
      const details = (data && (data.details || data.error)) ? (data.details || data.error) : `HTTP ${resp.status}`;
      updateError(details);
      try { await fetch('/api/logs', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ level:'error', message:'generate failed', details }) }); } catch(e){}
      return;
    }
    updateReady({ imageUrl: data.imageUrl, details: data.message || '' });
    updateStatusSummary();
  } catch (err) {
    updateError(err?.message || String(err));
    try { await fetch('/api/logs', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ level:'error', message:'network error generate', details: String(err) }) }); } catch(e){}
  }
}

/* Negative prompt helper exports for UI (no visible textarea): */
function clearNegativePrompt() { if (document.getElementById('negativePromptHidden')) document.getElementById('negativePromptHidden').value = ''; }
window.applyNegativePreset = applyNegativePreset;
window.appendTrait = appendTrait;

/* Misc controls */
document.getElementById('randomSeedBtn').addEventListener('click', () => { document.getElementById('seedInput').value = Math.floor(Math.random() * 1000000); });
document.getElementById('clearAllBtn').addEventListener('click', () => { if (confirm('Clear all results?')) { resultsArea.innerHTML = ''; updateStatusSummary(); } });

/* Init */
document.addEventListener('DOMContentLoaded', () => {
  populateModelDropdown().catch(()=>{});
  document.getElementById('generateBtn').addEventListener('click', generateImage);
  document.getElementById('promptInput').addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); generateImage(); } });
  if (isLikelyImageUrl(imgRefInput.value)) addImgBtn.classList.remove('hidden');
  // make sure useRefAspect button references exist
  document.getElementById('useImgAspectBtn').addEventListener('click', () => {
    if (window._lastRefAspect) {
      const [w,h] = window._lastRefAspect;
      document.getElementById('widthInput').value = Math.max(128, Math.round(w));
      document.getElementById('heightInput').value = Math.max(128, Math.round(h));
      document.getElementById('detectedAspectLabel').textContent = `Ref ${Math.round(w)}Ã—${Math.round(h)}`;
    }
  });
});

/* close preview on backdrop click */
document.getElementById('previewModal').addEventListener('click', (e) => {
  if (e.target === document.getElementById('previewModal') || e.target.classList.contains('modal-backdrop')) closePreview();
});
</script>
</body>
</html>
